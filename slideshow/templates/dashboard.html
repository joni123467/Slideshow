{% extends 'layout.html' %}
{% block title %}Übersicht – Slideshow{% endblock %}
{% block content %}
<section class="grid overview-grid">
  <article>
    <h2>Aktueller Status</h2>
    <div class="status-flags">
      <span data-status="service" class="status-indicator {% if service_active %}status-indicator--ok{% else %}status-indicator--down{% endif %}">
        {% if service_active %}Dienst läuft{% else %}Dienst ist inaktiv{% endif %}
      </span>
      <span data-status="info" class="status-indicator {% if state and state.info_screen %}status-indicator--info{% else %}status-indicator--neutral{% endif %}">
        {% if state and state.info_screen %}Infobildschirm aktiv{% else %}Infobildschirm aus{% endif %}
      </span>
    </div>
    <div class="status-block">
      <h3>Primäre Anzeige</h3>
      <p><strong>Quelle:</strong> <span data-state="primary-source">{{ state.primary_source or '–' }}</span></p>
      <p><strong>Datei:</strong> <span data-state="primary-item">{{ state.primary_media_path or state.primary_item or '–' }}</span></p>
      <p><strong>Status:</strong> <span data-state="primary-status">{{ state.primary_status or 'unbekannt' }}</span></p>
      <p><strong>Gestartet:</strong> <span data-state="primary-started">{% if state.primary_started_at %}{{ state.primary_started_at | datetimeformat }}{% else %}–{% endif %}</span></p>
      <div class="status-preview" data-preview="primary">
        <div class="status-preview__frame">
          <img data-preview-image="primary" src="{{ url_for('state_preview', side='primary') }}" alt="Vorschau primäre Anzeige" hidden />
          <span data-preview-placeholder="primary" class="status-preview__placeholder">Keine Vorschau verfügbar</span>
        </div>
      </div>
    </div>
    {% if config.playback.splitscreen_enabled %}
    <div class="status-block" data-secondary-status>
      <h3>Splitscreen rechts</h3>
      <p><strong>Quelle:</strong> <span data-state="secondary-source">{{ state.secondary_source or '–' }}</span></p>
      <p><strong>Datei:</strong> <span data-state="secondary-item">{{ state.secondary_media_path or state.secondary_item or '–' }}</span></p>
      <p><strong>Status:</strong> <span data-state="secondary-status">{{ state.secondary_status or 'unbekannt' }}</span></p>
      <p><strong>Gestartet:</strong> <span data-state="secondary-started">{% if state.secondary_started_at %}{{ state.secondary_started_at | datetimeformat }}{% else %}–{% endif %}</span></p>
      <div class="status-preview" data-preview="secondary">
        <div class="status-preview__frame">
          <img data-preview-image="secondary" src="{{ url_for('state_preview', side='secondary') }}" alt="Vorschau sekundäre Anzeige" hidden />
          <span data-preview-placeholder="secondary" class="status-preview__placeholder">Keine Vorschau verfügbar</span>
        </div>
      </div>
    </div>
    {% endif %}
    <p><strong>Infobildschirm:</strong> <span data-state="info-screen">{% if state.info_screen %}aktiv{% else %}inaktiv{% endif %}{% if state.info_manual %} (manuell){% endif %}</span></p>
    <p><strong>Service-Status:</strong> {{ service_status or 'unbekannt' }}</p>
    <p><strong>Autostart:</strong> {% if config.playback.auto_start %}aktiviert{% else %}deaktiviert{% endif %}</p>
  </article>

  <article>
    <h2>Playlist-Vorschau</h2>
    {% if config.playback.splitscreen_enabled %}
    <p class="muted">Die Splitscreen-Wiedergabe nutzt getrennte Listen. Die linke bzw. rechte Seite berücksichtigt jeweils den gewählten Unterordner. Über die Checkboxen lassen sich einzelne Medien temporär aus- oder einschalten.</p>
    <div class="split-grid playlist-preview__split">
      <div>
        <h3>Linke Seite</h3>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Anzeigen</th>
                <th>#</th>
                <th>Vorschau</th>
                <th>Datei</th>
                <th>Quelle</th>
                <th>Typ</th>
              </tr>
            </thead>
            <tbody>
              {% for item in splitscreen_left %}
              {% set key = item.source ~ '|' ~ item.path %}
              {% set is_disabled = key in disabled_keys %}
              <tr class="{% if is_disabled %}playlist-disabled{% endif %}">
                <td>
                  <form method="post" action="{{ url_for('toggle_playlist_item') }}" class="playlist-toggle">
                    <input type="hidden" name="source" value="{{ item.source }}" />
                    <input type="hidden" name="path" value="{{ item.path }}" />
                    <input type="hidden" name="next" value="{{ url_for('dashboard') }}" />
                    <input type="hidden" name="enabled" value="{{ 0 if is_disabled else 1 }}" />
                    <input type="checkbox" {% if not is_disabled %}checked{% endif %} onchange="const field=this.form.querySelector('[name=\"enabled\"]'); if(field){field.value=this.checked?'1':'0';} this.form.submit();" title="{{ 'Medien anzeigen' if is_disabled else 'Medien ausblenden' }}" />
                  </form>
                </td>
                <td>{{ loop.index }}</td>
                <td>
                  {% if item.type == 'image' %}
                  <img class="playlist-preview" src="{{ url_for('media_preview', source=item.source, media_path=item.path) }}" alt="Vorschau von {{ item.path }}" loading="lazy" />
                  {% else %}
                  <span class="muted">—</span>
                  {% endif %}
                </td>
                <td>{{ item.path }}</td>
                <td>{{ item.source }}</td>
                <td>{{ item.type }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6">Keine Medien gefunden. Bitte Quellen oder Pfad prüfen.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div>
        <h3>Rechte Seite</h3>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Anzeigen</th>
                <th>#</th>
                <th>Vorschau</th>
                <th>Datei</th>
                <th>Quelle</th>
                <th>Typ</th>
              </tr>
            </thead>
            <tbody>
              {% for item in splitscreen_right %}
              {% set key = item.source ~ '|' ~ item.path %}
              {% set is_disabled = key in disabled_keys %}
              <tr class="{% if is_disabled %}playlist-disabled{% endif %}">
                <td>
                  <form method="post" action="{{ url_for('toggle_playlist_item') }}" class="playlist-toggle">
                    <input type="hidden" name="source" value="{{ item.source }}" />
                    <input type="hidden" name="path" value="{{ item.path }}" />
                    <input type="hidden" name="next" value="{{ url_for('dashboard') }}" />
                    <input type="hidden" name="enabled" value="{{ 0 if is_disabled else 1 }}" />
                    <input type="checkbox" {% if not is_disabled %}checked{% endif %} onchange="const field=this.form.querySelector('[name=\"enabled\"]'); if(field){field.value=this.checked?'1':'0';} this.form.submit();" title="{{ 'Medien anzeigen' if is_disabled else 'Medien ausblenden' }}" />
                  </form>
                </td>
                <td>{{ loop.index }}</td>
                <td>
                  {% if item.type == 'image' %}
                  <img class="playlist-preview" src="{{ url_for('media_preview', source=item.source, media_path=item.path) }}" alt="Vorschau von {{ item.path }}" loading="lazy" />
                  {% else %}
                  <span class="muted">—</span>
                  {% endif %}
                </td>
                <td>{{ item.path }}</td>
                <td>{{ item.source }}</td>
                <td>{{ item.type }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6">Keine Medien gefunden. Bitte Quellen oder Pfad prüfen.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% else %}
    <p class="muted">Die Wiedergabe wird automatisch aus allen aktiv überwachten Quellen aufgebaut. Neu hinzugefügte Dateien werden nach kurzer Zeit ohne manuelle Eingriffe angezeigt. Über die Checkboxen lassen sich einzelne Medien temporär aus- oder einschalten.</p>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Anzeigen</th>
            <th>#</th>
            <th>Vorschau</th>
            <th>Datei</th>
            <th>Quelle</th>
            <th>Typ</th>
          </tr>
        </thead>
        <tbody>
          {% for item in playlist %}
          {% set key = item.source ~ '|' ~ item.path %}
          {% set is_disabled = key in disabled_keys %}
          <tr class="{% if is_disabled %}playlist-disabled{% endif %}">
            <td>
              <form method="post" action="{{ url_for('toggle_playlist_item') }}" class="playlist-toggle">
                <input type="hidden" name="source" value="{{ item.source }}" />
                <input type="hidden" name="path" value="{{ item.path }}" />
                <input type="hidden" name="next" value="{{ url_for('dashboard') }}" />
                <input type="hidden" name="enabled" value="{{ 0 if is_disabled else 1 }}" />
                <input type="checkbox" {% if not is_disabled %}checked{% endif %} onchange="const field=this.form.querySelector('[name=\"enabled\"]'); if(field){field.value=this.checked?'1':'0';} this.form.submit();" title="{{ 'Medien anzeigen' if is_disabled else 'Medien ausblenden' }}" />
              </form>
            </td>
            <td>{{ loop.index }}</td>
            <td>
              {% if item.type == 'image' %}
              <img class="playlist-preview" src="{{ url_for('media_preview', source=item.source, media_path=item.path) }}" alt="Vorschau von {{ item.path }}" loading="lazy" />
              {% else %}
              <span class="muted">—</span>
              {% endif %}
            </td>
            <td>{{ item.path }}</td>
            <td>{{ item.source }}</td>
            <td>{{ item.type }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6">Keine Medien gefunden. Bitte prüfen, ob die Quellen erreichbar sind.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
    <a class="button-link" href="{{ url_for('media_settings') }}">Quellen verwalten</a>
  </article>
</section>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const stateTargets = {
      primaryItem: document.querySelector('[data-state="primary-item"]'),
      primaryStatus: document.querySelector('[data-state="primary-status"]'),
      primaryStarted: document.querySelector('[data-state="primary-started"]'),
      primarySource: document.querySelector('[data-state="primary-source"]'),
      secondaryItem: document.querySelector('[data-state="secondary-item"]'),
      secondaryStatus: document.querySelector('[data-state="secondary-status"]'),
      secondaryStarted: document.querySelector('[data-state="secondary-started"]'),
      secondarySource: document.querySelector('[data-state="secondary-source"]'),
      infoScreen: document.querySelector('[data-state="info-screen"]'),
    };

    const statusIndicators = {
      service: document.querySelector('[data-status="service"]'),
      info: document.querySelector('[data-status="info"]'),
    };

    const secondaryBlock = document.querySelector('[data-secondary-status]');
    const previewImages = {
      primary: document.querySelector('[data-preview-image="primary"]'),
      secondary: document.querySelector('[data-preview-image="secondary"]'),
    };
    const previewPlaceholders = {
      primary: document.querySelector('[data-preview-placeholder="primary"]'),
      secondary: document.querySelector('[data-preview-placeholder="secondary"]'),
    };
    const previewUrls = {
      primary: "{{ url_for('state_preview', side='primary') }}",
      secondary: "{{ url_for('state_preview', side='secondary') }}",
    };
    const formatter = new Intl.DateTimeFormat('de-DE', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
    });

    function formatTimestamp(value) {
      if (!value) {
        return '–';
      }
      const numeric = Number(value);
      if (!Number.isFinite(numeric) || numeric <= 0) {
        return '–';
      }
      return formatter.format(new Date(numeric * 1000));
    }

    function setIndicator(element, active, activeClass, inactiveClass, activeLabel, inactiveLabel) {
      if (!element) {
        return;
      }
      element.classList.remove('status-indicator--ok', 'status-indicator--down', 'status-indicator--info', 'status-indicator--neutral');
      element.classList.add(active ? activeClass : inactiveClass);
      element.textContent = active ? activeLabel : inactiveLabel;
    }

    function updatePreview(side, available, token, mediaType) {
      const image = previewImages[side];
      const placeholder = previewPlaceholders[side];
      if (!image || !placeholder) {
        return;
      }
      if (available) {
        image.hidden = false;
        image.src = `${previewUrls[side]}?t=${token || 0}`;
        placeholder.hidden = true;
      } else {
        image.hidden = true;
        placeholder.hidden = false;
        placeholder.textContent = mediaType === 'video' ? 'Video in Wiedergabe' : 'Keine Vorschau verfügbar';
      }
    }

    async function refreshState() {
      try {
        const response = await fetch('{{ url_for('api_state') }}', { cache: 'no-store' });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        if (stateTargets.primaryItem) stateTargets.primaryItem.textContent = data.primary_media_path || data.primary_item || '–';
        if (stateTargets.primaryStatus) stateTargets.primaryStatus.textContent = data.primary_status || 'unbekannt';
        if (stateTargets.primaryStarted) stateTargets.primaryStarted.textContent = formatTimestamp(data.primary_started_at);
        if (stateTargets.primarySource) stateTargets.primarySource.textContent = data.primary_source || '–';

        const hasSecondary = Boolean(data.secondary_item || data.secondary_status || data.secondary_started_at);
        if (secondaryBlock) {
          secondaryBlock.style.display = hasSecondary ? '' : 'none';
        }
        if (stateTargets.secondaryItem) stateTargets.secondaryItem.textContent = data.secondary_media_path || data.secondary_item || '–';
        if (stateTargets.secondaryStatus) stateTargets.secondaryStatus.textContent = data.secondary_status || 'unbekannt';
        if (stateTargets.secondaryStarted) stateTargets.secondaryStarted.textContent = formatTimestamp(data.secondary_started_at);
        if (stateTargets.secondarySource) stateTargets.secondarySource.textContent = data.secondary_source || '–';

        if (stateTargets.infoScreen) {
          const parts = [];
          parts.push(data.info_screen ? 'aktiv' : 'inaktiv');
          if (data.info_manual) {
            parts.push('(manuell)');
          }
          stateTargets.infoScreen.textContent = parts.join(' ');
        }

        updatePreview('primary', data.primary_preview_available, data.primary_preview_token, data.primary_media_type);
        updatePreview('secondary', data.secondary_preview_available, data.secondary_preview_token, data.secondary_media_type);

        setIndicator(statusIndicators.service, Boolean(data.service_active), 'status-indicator--ok', 'status-indicator--down', 'Dienst läuft', 'Dienst ist inaktiv');
        setIndicator(statusIndicators.info, Boolean(data.info_screen), 'status-indicator--info', 'status-indicator--neutral', 'Infobildschirm aktiv', 'Infobildschirm aus');
      } catch (err) {
        console.debug('Status konnte nicht aktualisiert werden', err);
      }
    }

    refreshState();
    setInterval(refreshState, 5000);
  })();
</script>
{% endblock %}
