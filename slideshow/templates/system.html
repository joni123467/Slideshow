{% extends 'layout.html' %}
{% block title %}System – Slideshow{% endblock %}
{% block content %}
<section class="grid system-grid">
  <article>
    <h2>Updates</h2>
    {% if has_branch_info %}
    <form method="post" action="{{ url_for('system_update') }}" class="grid-form">
      <label>Branch auswählen
        <select name="branch">
          {% for branch in branch_choices %}
          <option value="{{ branch }}" {% if current_branch and branch == current_branch %}selected{% endif %}>{{ branch }}</option>
          {% endfor %}
        </select>
      </label>
      <button type="submit">Update starten</button>
    </form>
    <p class="muted">Aktueller Branch: <strong>{{ current_branch or 'unbekannt' }}</strong></p>
    <p class="muted">Der Ablauf wird in <code>update.log</code> protokolliert und kann unten im Bereich „Protokolle“ eingesehen werden.</p>
    {% else %}
    <p class="muted">Git-Updates stehen in dieser Installation nicht zur Verfügung. Stelle sicher, dass das Repository über Git installiert wurde{% if fallback_repo %} oder prüfe die veröffentlichten Versionen unter <a href="https://github.com/{{ fallback_repo }}/branches" target="_blank" rel="noopener">GitHub</a>{% endif %}.</p>
    {% endif %}
  </article>

  <article>
    <h2>Service &amp; Aktionen</h2>
    <div class="status-flags">
      <span class="status-indicator {% if service_active %}status-indicator--ok{% else %}status-indicator--down{% endif %}">
        {% if service_active %}Dienst läuft{% else %}Dienst ist inaktiv{% endif %}
      </span>
      <span class="muted">Status laut systemd: {{ service_status or 'unbekannt' }}</span>
    </div>
    <div class="button-row">
      <form method="post" action="{{ url_for('system_service', action='restart') }}">
        <button type="submit">Service neu starten</button>
      </form>
      <form method="post" action="{{ url_for('system_service', action='start') }}">
        <button type="submit">Service starten</button>
      </form>
      <form method="post" action="{{ url_for('system_service', action='stop') }}">
        <button type="submit">Service stoppen</button>
      </form>
    </div>
    <div class="button-row">
      <form method="post" action="{{ url_for('system_reboot') }}" onsubmit="return confirm('Raspberry Pi wirklich neu starten?');">
        <button type="submit">Raspberry Pi neu starten</button>
      </form>
      <form method="post" action="{{ url_for('system_shutdown') }}" onsubmit="return confirm('Raspberry Pi herunterfahren?');">
        <button type="submit" class="danger">Herunterfahren</button>
      </form>
    </div>
  </article>

  <article>
    <h2>Automatischer Neustart</h2>
    <form method="post" action="{{ url_for('update_maintenance_settings') }}" class="grid-form">
      <label>
        <input type="checkbox" name="auto_reboot_enabled" value="1" {% if config.maintenance.auto_reboot_enabled %}checked{% endif %} />
        Täglichen Neustart aktivieren
      </label>
      <label>Uhrzeit (HH:MM)
        <input type="time" name="auto_reboot_time" value="{{ config.maintenance.auto_reboot_time }}" required pattern="^([01]?\d|2[0-3]):[0-5]\d$" />
      </label>
      <button type="submit">Einstellungen speichern</button>
    </form>
    {% if next_reboot %}
    <p class="muted">Nächster geplanter Neustart: <strong>{{ next_reboot.strftime('%d.%m.%Y %H:%M') }}</strong></p>
    {% elif config.maintenance.auto_reboot_enabled %}
    <p class="muted">Nächster Neustart wird berechnet …</p>
    {% else %}
    <p class="muted">Automatischer Neustart ist deaktiviert.</p>
    {% endif %}
  </article>

  <article>
    <h2>Konfiguration</h2>
    <div class="button-row">
      <a class="button-link" href="{{ url_for('export_config') }}">Konfiguration exportieren</a>
    </div>
    <form method="post" action="{{ url_for('import_config') }}" enctype="multipart/form-data" class="inline-form">
      <label>Datei auswählen
        <input type="file" name="config_file" accept=".zip,.yml,.yaml,.json" required />
      </label>
      <button type="submit">Konfiguration importieren</button>
      <p class="muted">Unterstützt werden exportierte ZIP-Archive oder eine einzelne <code>config.yml</code>.</p>
    </form>
    <form method="post" action="{{ url_for('update_theme') }}" class="inline-form theme-form">
      <label>Theme auswählen
        <select name="theme">
          {% for value, label in theme_choices %}
          <option value="{{ value }}" {% if config.ui.theme == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>
      <button type="submit">Theme übernehmen</button>
    </form>
  </article>

  <article class="logs">
    <h2>Protokolle</h2>
    <div class="log-controls">
      <label>Log auswählen
        <select id="log-select">
          {% for key, info in log_sources.items() %}
          <option value="{{ key }}">{{ info.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Zeilen
        <input type="number" id="log-lines" value="200" min="10" max="2000" />
      </label>
      <button type="button" id="log-refresh">Aktualisieren</button>
      <a id="log-download" class="button-link" href="#" download>Herunterladen</a>
    </div>
    <pre id="log-output">Wähle ein Log aus, um den Inhalt zu laden.</pre>
  </article>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('log-select');
    const output = document.getElementById('log-output');
    const linesInput = document.getElementById('log-lines');
    const refresh = document.getElementById('log-refresh');
    const downloadLink = document.getElementById('log-download');
    const baseUrl = "{{ url_for('show_log', name='__LOG__') }}";
    const downloadBase = "{{ url_for('download_log', name='__LOG__') }}";

    async function loadLog() {
      if (!select || !output) {
        return;
      }
      const name = select.value;
      const lines = linesInput && linesInput.value ? linesInput.value : '200';
      if (!name) {
        output.textContent = 'Keine Logdatei ausgewählt.';
        if (downloadLink) {
          downloadLink.classList.add('is-disabled');
          downloadLink.href = '#';
        }
        return;
      }
      if (downloadLink) {
        downloadLink.classList.remove('is-disabled');
        downloadLink.href = downloadBase.replace('__LOG__', encodeURIComponent(name));
      }
      output.textContent = 'Lade Log …';
      try {
        const response = await fetch(baseUrl.replace('__LOG__', encodeURIComponent(name)) + `?lines=${encodeURIComponent(lines)}`);
        if (!response.ok) {
          output.textContent = `Fehler beim Laden (${response.status})`;
          return;
        }
        const text = await response.text();
        output.textContent = text || 'Keine Einträge vorhanden.';
      } catch (error) {
        output.textContent = 'Fehler beim Abrufen des Logs.';
      }
    }

    if (refresh) {
      refresh.addEventListener('click', loadLog);
    }
    if (select) {
      select.addEventListener('change', loadLog);
    }
    if (linesInput) {
      linesInput.addEventListener('change', loadLog);
    }

    if (select && select.value) {
      loadLog();
    } else if (downloadLink) {
      downloadLink.classList.add('is-disabled');
      downloadLink.href = '#';
    }
  });
</script>
{% endblock %}
