{% extends 'layout.html' %}
{% block title %}Wiedergabe – Slideshow{% endblock %}
{% block content %}
<section class="grid">
  <article>
    <h2>Steuerung</h2>
    <div class="button-row">
      <form method="post" action="{{ url_for('player_control', action='start') }}">
        <button type="submit">Slideshow starten</button>
      </form>
      <form method="post" action="{{ url_for('player_control', action='stop') }}">
        <button type="submit">Slideshow stoppen</button>
      </form>
      <form method="post" action="{{ url_for('player_control', action='reload') }}">
        <button type="submit">Playlist neu laden</button>
      </form>
    </div>
    <form method="post" action="{{ url_for('player_info_screen') }}">
      <p class="muted">Aktueller Status: {% if state and state.info_manual %}Infobildschirm wurde manuell aktiviert{% else %}Infobildschirm ist deaktiviert{% endif %}.</p>
      {% if config.playback.info_screen_enabled and not config.playback.splitscreen_enabled %}
      <p class="muted">Der Infobildschirm erscheint automatisch, sobald keine Medien gefunden werden.</p>
      {% endif %}
      {% if state and state.info_manual %}
      <input type="hidden" name="enabled" value="0" />
      <button type="submit">Infobildschirm deaktivieren</button>
      {% else %}
      <input type="hidden" name="enabled" value="1" />
      <button type="submit">Infobildschirm aktivieren</button>
      {% endif %}
    </form>
  </article>

  <article>
    <h2>Einstellungen</h2>
    <form method="post" action="{{ url_for('update_playback_settings') }}" class="grid-form">
      <label>Bilddauer (Sekunden)
        <input type="number" name="image_duration" min="1" value="{{ config.playback.image_duration }}" required />
      </label>
      <label>Bilddarstellung
        <select name="image_fit">
          <option value="contain" {% if config.playback.image_fit == 'contain' %}selected{% endif %}>Einpassen (mit Rändern)</option>
          <option value="stretch" {% if config.playback.image_fit == 'stretch' %}selected{% endif %}>Strecken</option>
          <option value="original" {% if config.playback.image_fit == 'original' %}selected{% endif %}>Originalgröße</option>
        </select>
      </label>
      <label>Rotation (°)
        <input type="number" name="image_rotation" min="0" max="359" value="{{ config.playback.image_rotation }}" />
      </label>
      <label>Übergang
        <select name="transition_type">
          {% for value, label in transition_options %}
          <option value="{{ value }}" {% if config.playback.transition_type == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>Übergangsdauer (Sekunden)
        <input type="number" step="0.1" min="0.2" max="10" name="transition_duration" value="{{ config.playback.transition_duration }}" />
      </label>
      {% set current_resolution = config.playback.display_resolution %}
      {% set show_custom = current_resolution not in resolution_values and (not detected_resolution or current_resolution != detected_resolution) %}
      <label>Anzeigeauflösung
        <div class="resolution-picker">
          <select name="display_resolution_choice" id="display-resolution-choice">
            {% if detected_resolution and detected_resolution not in resolution_values %}
            <option value="{{ detected_resolution }}" {% if current_resolution == detected_resolution %}selected{% endif %}>{{ detected_resolution }} (erkannt)</option>
            {% endif %}
            {% for value, label in display_resolution_choices %}
            <option value="{{ value }}" {% if current_resolution == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
            <option value="custom" {% if show_custom %}selected{% endif %}>Benutzerdefiniert</option>
          </select>
          <input type="text" name="display_resolution_custom" id="display-resolution-custom" value="{% if show_custom %}{{ current_resolution }}{% endif %}" placeholder="z. B. 1920x1080" {% if not show_custom %}hidden disabled{% endif %} />
        </div>
        {% if detected_resolution %}
        <small class="muted">Erkannte Auflösung: <strong>{{ detected_resolution }}</strong>. Wähle „Benutzerdefiniert“, um einen anderen Wert einzugeben.</small>
        {% else %}
        <small class="muted">Wähle eine passende Auflösung oder nutze „Benutzerdefiniert“ für eigene Werte.</small>
        {% endif %}
      </label>
      <label>Zusätzliche Video-Argumente
        <textarea name="video_player_args" rows="3" placeholder="z. B. --vo=gpu">{{ config.playback.video_player_args | default([], true) | join('\n') }}</textarea>
        <small class="muted">Ein Argument pro Zeile; leer lassen, um die Standardwerte zu verwenden.</small>
      </label>
      <label>Zusätzliche Bild-Argumente
        <textarea name="image_viewer_args" rows="3" placeholder="z. B. --vo=gpu">{{ config.playback.image_viewer_args | default([], true) | join('\n') }}</textarea>
        <small class="muted">Ein Argument pro Zeile.</small>
      </label>
      <fieldset class="splitscreen">
        <legend>Splitscreen</legend>
        <label class="checkbox">
          <input type="checkbox" id="splitscreen-toggle" name="splitscreen_enabled" value="1" {% if config.playback.splitscreen_enabled %}checked{% endif %} /> Aktivieren
        </label>
        <label class="split-ratio" {% if not config.playback.splitscreen_enabled %}hidden{% endif %}>
          Aufteilung (links/rechts)
          <div class="split-ratio__controls">
            <input type="range" min="10" max="90" name="splitscreen_ratio" id="splitscreen-ratio" value="{{ config.playback.splitscreen_ratio }}" />
            <span class="muted"><span id="splitscreen-ratio-label">{{ config.playback.splitscreen_ratio }}</span>% links</span>
          </div>
        </label>
        <div class="split-grid" {% if not config.playback.splitscreen_enabled %}hidden{% endif %}>
          <div>
            <h4>Linke Seite</h4>
            <label>Quelle
              <select name="splitscreen_left_source">
                <option value="">(keine)</option>
                {% for source in sources %}
                <option value="{{ source.name }}" {% if config.playback.splitscreen_left_source == source.name %}selected{% endif %}>{{ source.name }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Pfad (optional)
              <input type="text" name="splitscreen_left_path" value="{{ config.playback.splitscreen_left_path }}" />
              <small class="muted">Relativer Unterordner innerhalb der Quelle, z. B. <code>bilder\\links</code> oder <code>bilder/links</code>.</small>
            </label>
          </div>
          <div>
            <h4>Rechte Seite</h4>
            <label>Quelle
              <select name="splitscreen_right_source">
                <option value="">(keine)</option>
                {% for source in sources %}
                <option value="{{ source.name }}" {% if config.playback.splitscreen_right_source == source.name %}selected{% endif %}>{{ source.name }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Pfad (optional)
              <input type="text" name="splitscreen_right_path" value="{{ config.playback.splitscreen_right_path }}" />
              <small class="muted">Relativer Unterordner innerhalb der Quelle, z. B. <code>videos\\rechts</code> oder <code>videos/rechts</code>.</small>
            </label>
          </div>
        </div>
      </fieldset>
      <button type="submit">Einstellungen speichern</button>
    </form>
  </article>
</section>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const toggle = document.getElementById('splitscreen-toggle');
    const grid = document.querySelector('.split-grid');
    const ratioWrapper = document.querySelector('.split-ratio');
    const ratioInput = document.getElementById('splitscreen-ratio');
    const ratioLabel = document.getElementById('splitscreen-ratio-label');
    if (!toggle || !grid) {
      return;
    }

    const updateVisibility = () => {
      grid.hidden = !toggle.checked;
      if (ratioWrapper) {
        ratioWrapper.hidden = !toggle.checked;
      }
    };

    const updateLabel = () => {
      if (!ratioInput || !ratioLabel) {
        return;
      }
      ratioLabel.textContent = ratioInput.value;
    };

    toggle.addEventListener('change', updateVisibility);
    if (ratioInput) {
      ratioInput.addEventListener('input', updateLabel);
      ratioInput.addEventListener('change', updateLabel);
      updateLabel();
    }
    updateVisibility();

    const resolutionChoice = document.getElementById('display-resolution-choice');
    const resolutionCustom = document.getElementById('display-resolution-custom');

    const updateResolutionVisibility = () => {
      if (!resolutionChoice || !resolutionCustom) {
        return;
      }
      const useCustom = resolutionChoice.value === 'custom';
      resolutionCustom.hidden = !useCustom;
      resolutionCustom.disabled = !useCustom;
    };

    if (resolutionChoice) {
      resolutionChoice.addEventListener('change', updateResolutionVisibility);
      updateResolutionVisibility();
    }
  })();
</script>
{% endblock %}
